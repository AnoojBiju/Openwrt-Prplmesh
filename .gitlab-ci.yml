variables:
  PYTHONUNBUFFERED: "1"
  ARTIFACT_DOWNLOAD_ATTEMPTS: 3
  GET_SOURCES_ATTEMPTS: 3

default:
  interruptible: true

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" || $CI_PIPELINE_SOURCE == "web"'
    # Cfr. Workflows/MergeRequest-Pipelines.gitlab-ci.yml template
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

stages:
  - platform
  - certification-dummy

include:
  - local: "/ci/templates.yml"

.rules-for-expensive-job: &expensive-job
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_MERGE_REQUEST_EVENT_TYPE == "merge_train"'
    - if: $CI_COMMIT_TAG
    - when: manual
      allow_failure: true

platform:
  stage: platform
  needs:
  variables:
    STABILITY_TESTS: $STABILITY_TESTS
    ALTRAN_TESTS: $ALTRAN_TESTS
    TESTS_TO_RUN_ESSENSIUM: $TESTS_TO_RUN_ESSENSIUM
    DEVICE_UNDER_TEST_ESSENSIUM: $DEVICE_UNDER_TEST_ESSENSIUM
    TESTS_TO_RUN_ISR: $TESTS_TO_RUN_ISR
    DEVICE_UNDER_TEST_ISR: $DEVICE_UNDER_TEST_ISR
    TESTS_TO_RUN_R2_ESSENSIUM: $TESTS_TO_RUN_R2_ESSENSIUM
    DEVICE_UNDER_TEST_R2_ESSENSIUM: $DEVICE_UNDER_TEST_R2_ESSENSIUM
    TESTS_TO_RUN_R4_ESSENSIUM: $TESTS_TO_RUN_R4_ESSENSIUM
    DEVICE_UNDER_TEST_R4_ESSENSIUM: $DEVICE_UNDER_TEST_R4_ESSENSIUM
    PARENT_PIPELINE_ID: $CI_PIPELINE_ID
    CI_PARENT_PIPELINE_SOURCE: $CI_PIPELINE_SOURCE
    BUILD_CGR: $BUILD_CGR
  trigger:
    include: "ci/platform.yml"
    strategy: depend
